{% extends 'base.html' %}
{% load static %}

{% block title %}Newsletter Admin - Portfolio{% endblock %}

{% block extra_css %}
<style>
    .admin-card {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }
    
    .stat-card {
        background-color: #172554;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        height: 150px;
        border: 1px solid #1E40AF;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .stat-number {
        font-size: 3rem;
        margin: 10px 0;
        color: white;
        font-weight: bold;
    }
    
    .stat-label {
        color: #60A5FA;
        font-size: 1.1rem;
    }
    
    .control-panel {
        background-color: #1E3A8A;
        padding: 25px;
        border-radius: 10px;
        margin: 20px 0;
        border: 1px solid #2563EB;
    }
    
    .newsletter-preview {
        background-color: #172554;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #1E40AF;
        height: 100%;
    }
    
    .btn-send {
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        border: none;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        color: white;
    }
    
    .btn-test {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border: none;
        color: white;
        font-weight: 600;
    }
    
    .btn-test:hover {
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="admin-card">
        <h1 class="mb-3">üîê Newsletter Admin Dashboard</h1>
        <p class="mb-0">Manage subscribers and send newsletters to your tech community</p>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="stat-card">
                <div class="stat-label">Total Subscribers</div>
                <div class="stat-number">{{ subscriber_count }}</div>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="stat-card">
                <div class="stat-label">Recent Campaigns</div>
                <div class="stat-number">{{ recent_campaigns.count }}</div>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="stat-card">
                <div class="stat-label">Newsletter Status</div>
                <div style="font-size: 1.5rem; margin: 10px 0; color: #FBBF24;">Ready to Send</div>
            </div>
        </div>
    </div>

    <!-- Newsletter Control Panel -->
    <div class="control-panel">
        <h3 class="text-white text-center mb-4">Newsletter Control Panel</h3>
        
        <div class="row">
            <!-- Today's Newsletter Preview -->
            <div class="col-md-6 mb-3">
                <div class="newsletter-preview">
                    <h4 class="text-white mb-3">üì∞ Today's Newsletter</h4>
                    {% if article_title and article_link %}
                        <p class="text-white"><strong>Title:</strong> {{ article_title }}</p>
                        <p class="text-white"><strong>Link:</strong> <a href="{{ article_link }}" target="_blank" class="text-info">Read the full article</a></p>
                        <div class="alert alert-info mt-3">
                            <strong>Preview:</strong><br>
                            Today's Top Tech article: {{ article_title }}<br>
                            Read more at: {{ article_link }}
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            Unable to fetch today's article. Please try again later.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Send Newsletter Controls -->
            <div class="col-md-6 mb-3">
                <div class="newsletter-preview">
                    <h4 class="text-white mb-3">üì§ Send Newsletter</h4>
                    <p class="text-white mb-3">Send the daily newsletter to all {{ subscriber_count }} subscribers with one click.</p>
                    
                    <form method="post" action="{% url 'send_newsletter' %}" class="mb-4" id="sendNewsletterForm">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-send w-100 mb-3" id="sendNewsletterBtn">
                            üìß Send to All {{ subscriber_count }} Subscribers
                        </button>
                    </form>
                    
                    <hr class="text-white">
                    
                    <h5 class="text-white mb-3">üß™ Test Newsletter</h5>
                    <form method="post" action="{% url 'send_test_newsletter' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <input type="email" name="test_email" class="form-control" placeholder="your.email@example.com" required>
                        </div>
                        <button type="submit" class="btn btn-test w-100">
                            üì§ Send Test Email
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriber Management -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">üë• Subscriber Management</h4>
        </div>
        <div class="card-body">
            {% if subscribers %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Subscribed Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subscriber in subscribers %}
                            <tr>
                                <td>{{ subscriber.name }}</td>
                                <td>{{ subscriber.email }}</td>
                                <td>{{ subscriber.phone|default:"-" }}</td>
                                <td>{{ subscriber.subscribed_at|date:"M d, Y" }}</td>
                                <td>
                                    {% if subscriber.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Export Options -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <a href="data:text/csv;charset=utf-8,Name,Email,Phone,Subscribed Date,Status{% for subscriber in subscribers %}%0A{{ subscriber.name }},{{ subscriber.email }},{{ subscriber.phone|default:'' }},{{ subscriber.subscribed_at|date:'Y-m-d' }},{% if subscriber.is_active %}Active{% else %}Inactive{% endif %}{% endfor %}" 
                           download="subscribers.csv" 
                           class="btn btn-outline-primary">
                            üì• Export as CSV
                        </a>
                    </div>
                    <div class="col-md-6 text-end">
                        <a href="{% url 'newsletter' %}" class="btn btn-secondary">
                            ‚Üê Back to Newsletter
                        </a>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <h5 class="text-muted">No subscribers yet</h5>
                    <p class="text-muted">Share your subscription form to get started!</p>
                    <a href="{% url 'newsletter' %}" class="btn btn-primary">
                        Go to Newsletter Page
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Blog Posts Section -->
    {% if recent_blog_posts %}
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">üìù Send Blog Posts to Newsletter</h4>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Send your latest blog posts to newsletter subscribers with a snippet and "read more" link.</p>

            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for blog_post in recent_blog_posts %}
                        <tr>
                            <td>
                                <strong>{{ blog_post.title }}</strong>
                                <br>
                                <small class="text-muted">{{ blog_post.content|striptags|truncatewords:20 }}</small>
                            </td>
                            <td>{{ blog_post.created_at|date:"M d, Y" }}</td>
                            <td>
                                {% if blog_post.sent_to_newsletter %}
                                    <span class="badge bg-success">‚úÖ Sent</span>
                                {% else %}
                                    <span class="badge bg-warning">üìß Not Sent</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not blog_post.sent_to_newsletter %}
                                    <form method="post" action="{% url 'send_blog_post_to_newsletter' blog_post.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-success"
                                                onclick="return confirm('Send this blog post to {{ subscriber_count }} subscribers?')">
                                            üì§ Send to Newsletter
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="text-muted">Already sent</span>
                                {% endif %}
                                <a href="{% url 'blog_detail' blog_post.slug %}" class="btn btn-sm btn-outline-primary ms-1" target="_blank">
                                    üëÅÔ∏è View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if not recent_blog_posts %}
            <div class="text-center py-4">
                <h5 class="text-muted">No blog posts available</h5>
                <p class="text-muted">Create some blog posts to send them to your newsletter subscribers!</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Campaigns -->
    {% if recent_campaigns %}
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0">üìä Recent Campaigns</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Subject</th>
                            <th>Sent Date</th>
                            <th>Total Sent</th>
                            <th>Success Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for campaign in recent_campaigns %}
                        <tr>
                            <td>{{ campaign.title }}</td>
                            <td>{{ campaign.subject }}</td>
                            <td>
                                {% if campaign.sent_at %}
                                    {{ campaign.sent_at|date:"M d, Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Not sent</span>
                                {% endif %}
                            </td>
                            <td>{{ campaign.total_sent }}</td>
                            <td>
                                {% if campaign.total_sent > 0 %}
                                    {% widthratio campaign.success_count campaign.total_sent 100 %}%
                                    <small class="text-muted">({{ campaign.success_count }}/{{ campaign.total_sent }})</small>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add loading state to send buttons
    const sendButtons = document.querySelectorAll('button[type="submit"]');
    sendButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            // Don't prevent default form submission
            const originalText = this.innerHTML;
            
            // Add loading state after a short delay to allow form submission
            setTimeout(() => {
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
                this.disabled = true;
            }, 100);
            
            // Re-enable after 10 seconds as fallback
            setTimeout(() => {
                this.innerHTML = originalText;
                this.disabled = false;
            }, 10000);
        });
    });
    
    // Add confirmation for main newsletter send button
    const mainSendBtn = document.getElementById('sendNewsletterBtn');
    if (mainSendBtn) {
        mainSendBtn.addEventListener('click', function(e) {
            const subscriberCount = '{{ subscriber_count }}';
            if (!confirm(`Are you sure you want to send the newsletter to all ${subscriberCount} subscribers?`)) {
                e.preventDefault();
                return false;
            }
        });
    }
});
</script>
{% endblock %}
